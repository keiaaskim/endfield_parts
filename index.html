<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—”ë“œí•„ë“œ íŒŒë° ëŒ€ì‹œë³´ë“œ v1.3</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #fbac24; --border: #333; --white: #ffffff; --highlight-all: rgba(251, 172, 36, 0.2); --highlight-pri: rgba(56, 189, 248, 0.2); }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* ë ˆì´ì•„ì›ƒ ì œì–´ */
        .left-panel { flex: 1; overflow-y: auto; padding: 20px; border-right: 1px solid var(--border); }
        .right-panel { width: 400px; padding: 20px; background: var(--card); display: flex; flex-direction: column; gap: 15px; overflow-y: auto; flex-shrink: 0; }
        
        /* ë¹„ìœ¨ ê¸°ë°˜ í…Œì´ë¸” ì„¤ì • */
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; table-layout: fixed; }
        thead { position: sticky; top: 0; background: var(--card); z-index: 10; }
        th, td { padding: 14px 5px; text-align: center; border-bottom: 1px solid var(--border); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* ì—´ë³„ ë¹„ìœ¨ í• ë‹¹ (Total 100%) */
        .col-name { width: 25%; }
        .col-char { width: 15%; }
        .col-check { width: 8%; }  /* ë³´ìœ , ìš°ì„ , í™•ë³´ ê³µí†µ */
        .col-attr  { width: 12%; } /* ê¸°ì´ˆ, ì¶”ê°€, ìŠ¤í‚¬ ê³µí†µ */

        th { color: var(--accent); font-weight: 600; border-bottom: 2px solid var(--border); }
        tr:hover { background: #252525; }
        tr.active-all { background: var(--highlight-all) !important; border-left: 4px solid var(--accent); }
        tr.active-pri { background: var(--highlight-pri) !important; border-left: 4px solid #38bdf8; }

        /* ë¶„ì„ ì¹´ë“œ ë””ìì¸ */
        .analysis-card { background: #252525; padding: 25px; border-radius: 12px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .analysis-card.active { border: 2px solid var(--accent); }
        .btn { background: var(--accent); color: #000; padding: 18px; border: none; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1.1rem; margin-bottom: 10px; }
        
        .card-header { font-size: 1.2rem; color: var(--accent); font-weight: bold; margin-bottom: 20px; }
        .info-row { margin-bottom: 15px; }
        .info-label { display: block; font-size: 0.95rem; color: var(--white); font-weight: 700; margin-bottom: 8px; text-align: left; }
        
        .box-value { 
            display: inline-block; background: #333; color: var(--text); 
            padding: 8px 12px; border-radius: 6px; font-size: 1.1rem; 
            font-weight: 500; border: 1px solid #444; min-width: 60px; text-align: center;
        }
        .box-value.area { color: var(--accent); border-color: var(--accent); width: calc(100% - 24px); text-align: center; }
        .tag-group { display: flex; gap: 8px; justify-content: flex-start; flex-wrap: wrap; }
        .tag-free { color: #777; border-style: dashed; }
        .target-summary { margin-top: 15px; font-size: 1rem; color: var(--white); font-weight: bold; text-align: left; }
    </style>
</head>
<body>
    <div class="left-panel">
        <table>
            <thead>
                <tr>
                    <th class="col-name">ë¬´ê¸°ëª…</th><th class="col-char">ìºë¦­</th>
                    <th class="col-check">ë³´ìœ </th><th class="col-check">ìš°ì„ </th>
                    <th class="col-attr">ê¸°ì´ˆ</th><th class="col-attr">ì¶”ê°€</th><th class="col-attr">ìŠ¤í‚¬</th>
                    <th class="col-check">í™•ë³´</th>
                </tr>
            </thead>
            <tbody id="weapon-body"></tbody>
        </table>
    </div>

    <div class="right-panel">
        <div style="text-align: center;">
            <h2 style="margin: 0 0 15px 0; color: var(--accent); font-size: 1.5rem;">ğŸ¯ íŒŒë° ìŠ¤ìºë„ˆ</h2>
            <button class="btn" onclick="runFullAnalysis()">ì‹¤ì‹œê°„ ë°ì´í„° ë¶„ì„ ì‹œì‘</button>
        </div>
        <div id="card-all" class="analysis-card" onclick="toggleHighlight('all')">
            <div class="card-header">ğŸŒ ì „ì²´ ê¸°ì¤€ ìµœì </div>
            <div id="all-content">ë°ì´í„° ë¶„ì„ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”.</div>
        </div>
        <div id="card-pri" class="analysis-card" onclick="toggleHighlight('pri')">
            <div class="card-header">â­ ìš°ì„ ìˆœìœ„ ê¸°ì¤€ ìµœì </div>
            <div id="pri-content">ë°ì´í„° ë¶„ì„ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”.</div>
        </div>
    </div>

    <script>
        const WEAPON_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSvCoDDcCH_LVoRliGUwW0cAGOJtps8Ucmjj_ENOJxSuyGowRtq2heV5jh8VkVVTnwCoguGecjAkT6v/pub?gid=1336240927&single=true&output=csv";
        const PARTS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSvCoDDcCH_LVoRliGUwW0cAGOJtps8Ucmjj_ENOJxSuyGowRtq2heV5jh8VkVVTnwCoguGecjAkT6v/pub?gid=545530430&single=true&output=csv";

        let weaponData = [];
        let inventory = [];
        let analysisResults = { all: null, pri: null };

        async function init() {
            try {
                const [wRes, pRes] = await Promise.all([fetch(WEAPON_CSV), fetch(PARTS_CSV)]);
                weaponData = parseCSV(await wRes.text());
                inventory = parseCSV(await pRes.text());
                renderTable();
            } catch(e) { console.error(e); }
        }

        // ì¸ë²¤í† ë¦¬ ëŒ€ì¡° ìë™ ì²´í¬ ë¡œì§
        function checkAcquired(w) {
            return inventory.some(p => 
                p['ê¸°ì´ˆì†ì„±'] === w['ê¸°ì´ˆì†ì„±'] && p['ì¶”ê°€ì†ì„±'] === w['ì¶”ê°€ì†ì„±'] && p['ìŠ¤í‚¬ì†ì„±'] === w['ìŠ¤í‚¬ì†ì„±']
            );
        }

        function renderTable(highlightMode = null) {
            const body = document.getElementById('weapon-body');
            const sorted = [...weaponData].sort((a, b) => {
                const aDone = checkAcquired(a) ? 1 : 0;
                const bDone = checkAcquired(b) ? 1 : 0;
                if (aDone !== bDone) return aDone - bDone;
                const aPri = a['ìš°ì„ ìˆœìœ„'] === 'ã…‡' ? 1 : 0;
                const bPri = b['ìš°ì„ ìˆœìœ„'] === 'ã…‡' ? 1 : 0;
                if (aPri !== bPri) return bPri - aPri;
                return a['ê¸°ì´ˆì†ì„±'].localeCompare(b['ê¸°ì´ˆì†ì„±']);
            });

            body.innerHTML = sorted.map(w => {
                const isAcquired = checkAcquired(w) ? 'ã…‡' : '';
                let hClass = '';
                if (highlightMode === 'all' && analysisResults.all?.targets.some(t => t['ë¬´ê¸°ëª…'] === w['ë¬´ê¸°ëª…'])) hClass = 'active-all';
                if (highlightMode === 'pri' && analysisResults.pri?.targets.some(t => t['ë¬´ê¸°ëª…'] === w['ë¬´ê¸°ëª…'])) hClass = 'active-pri';

                return `<tr class="${hClass}">
                    <td>${w['ë¬´ê¸°ëª…']}</td><td>${w['ì‚¬ìš©ìºë¦­']}</td>
                    <td>${w['ë¬´ê¸°ë³´ìœ ']}</td><td>${w['ìš°ì„ ìˆœìœ„']}</td>
                    <td>${w['ê¸°ì´ˆì†ì„±']}</td><td>${w['ì¶”ê°€ì†ì„±']}</td>
                    <td>${w['ìŠ¤í‚¬ì†ì„±']}</td><td>${isAcquired}</td>
                </tr>`;
            }).join('');
        }

        async function runFullAnalysis() {
            const aRes = await fetch('areas.json');
            const areas = await aRes.json();
            const needed = weaponData.filter(w => !checkAcquired(w));
            const priorities = needed.filter(w => w['ìš°ì„ ìˆœìœ„'] === 'ã…‡');

            analysisResults.all = findBest(areas, needed);
            analysisResults.pri = findBest(areas, priorities);

            updateCardUI('all', analysisResults.all);
            updateCardUI('pri', analysisResults.pri);
            toggleHighlight('all');
        }

        function findBest(areas, list) {
            let best = { score: 0, targets: [] };
            if (list.length === 0) return null;
            areas.forEach(area => {
                [...new Set([...area.extra, ...area.skill])].forEach(fixed => {
                    const matches = list.filter(w => area.base.includes(w['ê¸°ì´ˆì†ì„±']) && (w['ì¶”ê°€ì†ì„±'] === fixed || w['ìŠ¤í‚¬ì†ì„±'] === fixed));
                    if (matches.length > 0) {
                        const baseCounts = {};
                        matches.forEach(w => baseCounts[w['ê¸°ì´ˆì†ì„±']] = (baseCounts[w['ê¸°ì´ˆì†ì„±']] || 0) + 1);
                        const topBases = Object.entries(baseCounts).sort((a,b) => b[1]-a[1]).slice(0,3).map(e => e[0]);
                        const finalTargets = matches.filter(w => topBases.includes(w['ê¸°ì´ˆì†ì„±']));
                        if (finalTargets.length > best.score) {
                            best = { area: area.name, fixed, bases: topBases, score: finalTargets.length, targets: finalTargets };
                        }
                    }
                });
            });
            return best.score > 0 ? best : null;
        }

        function updateCardUI(type, data) {
            const container = document.getElementById(`${type}-content`);
            if (!data) { container.innerHTML = "ëª©í‘œ ì—†ìŒ"; return; }
            let baseTags = data.bases.map(b => `<span class="box-value">${b}</span>`);
            while(baseTags.length < 3) baseTags.push(`<span class="box-value tag-free">ììœ </span>`);

            container.innerHTML = `
                <div class="info-row"><span class="info-label">íŒŒë° ì§€ì—­</span><span class="box-value area">${data.area}</span></div>
                <div class="info-row"><span class="info-label">ê³ ì • ìŠ¤í…Ÿ</span><div class="tag-group">${baseTags.join('')}</div></div>
                <div class="info-row"><span class="info-label">ê³ ì • ì†ì„±</span><span class="box-value" style="width:calc(100% - 24px);">${data.fixed}</span></div>
                <div class="target-summary">ğŸ¯ ${data.score}ì¢… ì €ê²© ê°€ëŠ¥</div>
            `;
        }

        function toggleHighlight(mode) {
            document.querySelectorAll('.analysis-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${mode}`).classList.add('active');
            renderTable(mode);
        }

        function parseCSV(csv) {
            const lines = csv.trim().split("\n");
            const headers = lines[0].split(",").map(h => h.trim().replace("\r", ""));
            return lines.slice(1).map(line => {
                const values = line.split(",").map(v => v.trim().replace("\r", ""));
                return headers.reduce((obj, h, i) => (obj[h] = values[i] || "", obj), {});
            });
        }
        init();
    </script>
</body>
</html>
