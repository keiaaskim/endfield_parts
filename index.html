<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—”ë“œí•„ë“œ íŒŒë° ëŒ€ì‹œë³´ë“œ</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #fbac24; --border: #333; --highlight: rgba(251, 172, 36, 0.2); }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* ë ˆì´ì•„ì›ƒ êµ¬ì„± */
        .left-panel { flex: 1; overflow-y: auto; padding: 20px; border-right: 1px solid var(--border); }
        .right-panel { width: 350px; padding: 20px; background: var(--card); display: flex; flex-direction: column; gap: 20px; }

        /* í…Œì´ë¸” ë””ìì¸ */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        thead { position: sticky; top: 0; background: var(--card); z-index: 10; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--accent); font-weight: 600; text-transform: uppercase; }
        tr:hover { background: #252525; }
        
        /* ë¶„ì„ ê²°ê³¼ í•˜ì´ë¼ì´íŠ¸ */
        tr.target-row { background: var(--highlight) !important; border-left: 4px solid var(--accent); }

        /* ì¹´ë“œ ë””ìì¸ */
        .analysis-card { background: #252525; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .btn { background: var(--accent); color: #000; padding: 15px; border: none; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1rem; }
        .result-item { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .tag { display: inline-block; background: #444; padding: 4px 8px; border-radius: 4px; margin: 2px; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="left-panel">
        <table id="weapon-table">
            <thead>
                <tr>
                    <th>ë¬´ê¸°ëª…</th><th>ìºë¦­</th><th>ë³´ìœ </th><th>ìš°ì„ </th><th>ê¸°ì´ˆ</th><th>ì¶”ê°€</th><th>ìŠ¤í‚¬</th><th>ê¸°ì§ˆ</th>
                </tr>
            </thead>
            <tbody id="weapon-body">
                </tbody>
        </table>
    </div>

    <div class="right-panel">
        <div class="analysis-card">
            <h2 style="margin-top:0; color:var(--accent);">ğŸ¯ íŒŒë° ìŠ¤ìºë„ˆ</h2>
            <button class="btn" onclick="runAnalysis()">ì‹¤ì‹œê°„ ë°ì´í„° ë¶„ì„</button>
            
            <div id="result-box" style="display:none;">
                <div class="result-item">
                    <small>ì¶”ì²œ ì§€ì—­</small><br><b id="res-area" style="font-size:1.2rem;">-</b>
                </div>
                <div class="result-item">
                    <small>ê³ ì • ì†ì„±</small><br><b id="res-fixed">-</b>
                </div>
                <div class="result-item">
                    <small>ê¸°ì´ˆì†ì„± 3ì¢…</small><div id="res-bases"></div>
                </div>
                <p id="res-summary" style="font-size:0.8rem; color:#888;"></p>
            </div>
        </div>
    </div>

    <script>
        const WEAPON_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSvCoDDcCH_LVoRliGUwW0cAGOJtps8Ucmjj_ENOJxSuyGowRtq2heV5jh8VkVVTnwCoguGecjAkT6v/pub?gid=1336240927&single=true&output=csv";
        const PARTS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSvCoDDcCH_LVoRliGUwW0cAGOJtps8Ucmjj_ENOJxSuyGowRtq2heV5jh8VkVVTnwCoguGecjAkT6v/pub?gid=545530430&single=true&output=csv";

        let weaponData = [];
        let inventory = [];

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        async function init() {
            const [wRes, pRes] = await Promise.all([fetch(WEAPON_CSV), fetch(PARTS_CSV)]);
            weaponData = parseCSV(await wRes.text());
            inventory = parseCSV(await pRes.text());
            renderTable();
        }

        function renderTable(targetList = []) {
            const body = document.getElementById('weapon-body');
            
            // ì •ë ¬ ë¡œì§
            const sorted = [...weaponData].sort((a, b) => {
                const aHasPart = a['ê¸°ì§ˆë³´ìœ '] === 'ã…‡' ? 1 : 0;
                const bHasPart = b['ê¸°ì§ˆë³´ìœ '] === 'ã…‡' ? 1 : 0;
                if (aHasPart !== bHasPart) return aHasPart - bHasPart; // 1ìˆœìœ„: ê¸°ì§ˆ ë¯¸ë³´ìœ  ìœ„ë¡œ

                const aHasWeapon = a['ë¬´ê¸°ë³´ìœ '] === 'ã…‡' ? 1 : 0;
                const bHasWeapon = b['ë¬´ê¸°ë³´ìœ '] === 'ã…‡' ? 1 : 0;
                if (aHasWeapon !== bHasWeapon) return bHasWeapon - aHasWeapon; // 2ìˆœìœ„: ë¬´ê¸° ë³´ìœ  ìš°ì„ 

                const aPriority = a['ìš°ì„ ìˆœìœ„'] === 'ã…‡' ? 1 : 0;
                const bPriority = b['ìš°ì„ ìˆœìœ„'] === 'ã…‡' ? 1 : 0;
                if (aPriority !== bPriority) return bPriority - aPriority; // 3ìˆœìœ„: ìš°ì„ ìˆœìœ„ ì²´í¬

                return a['ê¸°ì´ˆì†ì„±'].localeCompare(b['ê¸°ì´ˆì†ì„±']); // ë‚˜ë¨¸ì§€ ì†ì„±ìˆœ
            });

            body.innerHTML = sorted.map(w => {
                const isTarget = targetList.some(t => t['ë¬´ê¸°ëª…'] === w['ë¬´ê¸°ëª…']);
                return `
                    <tr class="${isTarget ? 'target-row' : ''}">
                        <td>${w['ë¬´ê¸°ëª…']}</td><td>${w['ì‚¬ìš©ìºë¦­']}</td>
                        <td>${w['ë¬´ê¸°ë³´ìœ ']}</td><td>${w['ìš°ì„ ìˆœìœ„']}</td>
                        <td>${w['ê¸°ì´ˆì†ì„±']}</td><td>${w['ì¶”ê°€ì†ì„±']}</td>
                        <td>${w['ìŠ¤í‚¬ì†ì„±']}</td><td>${w['ê¸°ì§ˆë³´ìœ ']}</td>
                    </tr>`;
            }).join('');
        }

        async function runAnalysis() {
            const aRes = await fetch('areas.json');
            const areas = await aRes.json();

            // ë¯¸ë³´ìœ  ê¸°ì§ˆ í•„í„°ë§ (ì¬ê³  ëŒ€ì¡°)
            const needed = weaponData.filter(w => !inventory.some(p => 
                p['ê¸°ì´ˆì†ì„±'] === w['ê¸°ì´ˆì†ì„±'] && p['ì¶”ê°€ì†ì„±'] === w['ì¶”ê°€ì†ì„±'] && p['ìŠ¤í‚¬ì†ì„±'] === w['ìŠ¤í‚¬ì†ì„±']
            ));

            let best = { score: -1, targets: [] };

            areas.forEach(area => {
                [...area.extra, ...area.skill].forEach(fixed => {
                    const matches = needed.filter(w => area.base.includes(w['ê¸°ì´ˆì†ì„±']) && (w['ì¶”ê°€ì†ì„±'] === fixed || w['ìŠ¤í‚¬ì†ì„±'] === fixed));
                    if (matches.length > 0) {
                        const baseCounts = {};
                        matches.forEach(w => baseCounts[w['ê¸°ì´ˆì†ì„±']] = (baseCounts[w['ê¸°ì´ˆì†ì„±']] || 0) + 1);
                        const topBases = Object.entries(baseCounts).sort((a,b) => b[1]-a[1]).slice(0,3).map(e => e[0]);
                        const finalTargets = matches.filter(w => topBases.includes(w['ê¸°ì´ˆì†ì„±']));
                        
                        if (finalTargets.length > best.score) {
                            best = { area: area.name, fixed, bases: topBases, score: finalTargets.length, targets: finalTargets };
                        }
                    }
                });
            });

            // ê²°ê³¼ ì—…ë°ì´íŠ¸ ë° í•˜ì´ë¼ì´íŠ¸
            document.getElementById('result-box').style.display = 'block';
            document.getElementById('res-area').innerText = best.area;
            document.getElementById('res-fixed').innerText = best.fixed;
            document.getElementById('res-bases').innerHTML = best.bases.map(b => `<span class="tag">${b}</span>`).join('');
            document.getElementById('res-summary').innerText = `â€» ë¯¸ë³´ìœ  ì¢…ê²° ê¸°ì§ˆ ${best.score}ì¢… ì €ê²© ê°€ëŠ¥`;
            
            renderTable(best.targets); // ì €ê²© ëŒ€ìƒ í•˜ì´ë¼ì´íŠ¸í•˜ì—¬ ì¬ë Œë”ë§
        }

        function parseCSV(csv) {
            const lines = csv.trim().split("\n");
            const headers = lines[0].split(",").map(h => h.trim().replace("\r", ""));
            return lines.slice(1).map(line => {
                const values = line.split(",").map(v => v.trim().replace("\r", ""));
                return headers.reduce((obj, h, i) => (obj[h] = values[i], obj), {});
            });
        }

        init();
    </script>
</body>
</html>
