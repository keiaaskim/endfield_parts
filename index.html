<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—”ë“œí•„ë“œ íŒŒë° ëŒ€ì‹œë³´ë“œ</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #fbac24; --border: #333; --highlight-all: rgba(251, 172, 36, 0.2); --highlight-pri: rgba(56, 189, 248, 0.2); }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .left-panel { flex: 1; overflow-y: auto; padding: 20px; border-right: 1px solid var(--border); }
        .right-panel { width: 380px; padding: 20px; background: var(--card); display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed; }
        thead { position: sticky; top: 0; background: var(--card); z-index: 10; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* ì»¬ëŸ¼ í­ ì„¤ì • */
        .col-name { width: auto; } .col-char { width: 80px; }
        .col-fixed { width: 50px; text-align: center; } 
        .col-attr { width: 70px; }

        th { color: var(--accent); font-weight: 600; }
        tr:hover { background: #252525; }
        
        /* í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        tr.active-all { background: var(--highlight-all) !important; border-left: 4px solid var(--accent); }
        tr.active-pri { background: var(--highlight-pri) !important; border-left: 4px solid #38bdf8; }

        .analysis-card { background: #252525; padding: 15px; border-radius: 12px; border: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .analysis-card:hover { border-color: var(--accent); }
        .analysis-card.active { border: 2px solid var(--accent); }
        .btn { background: var(--accent); color: #000; padding: 15px; border: none; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; font-size: 1rem; margin-bottom: 10px; }
        
        .res-title { font-size: 0.85rem; color: #888; margin-bottom: 8px; display: block; }
        .res-value { font-size: 1.1rem; font-weight: bold; color: #fff; }
        .tag { display: inline-block; background: #444; padding: 2px 6px; border-radius: 4px; margin: 2px; font-size: 0.75rem; }
    </style>
</head>
<body>
    <div class="left-panel">
        <table>
            <thead>
                <tr>
                    <th class="col-name">ë¬´ê¸°ëª…</th><th class="col-char">ìºë¦­</th>
                    <th class="col-fixed">ë³´ìœ </th><th class="col-fixed">ìš°ì„ </th>
                    <th class="col-attr">ê¸°ì´ˆ</th><th class="col-attr">ì¶”ê°€</th><th class="col-attr">ìŠ¤í‚¬</th>
                    <th class="col-fixed">í™•ë³´</th>
                </tr>
            </thead>
            <tbody id="weapon-body"></tbody>
        </table>
    </div>

    <div class="right-panel">
        <div style="text-align: center; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
            <h2 style="margin: 0 0 15px 0; color: var(--accent);">ğŸ¯ íŒŒë° ìŠ¤ìºë„ˆ</h2>
            <button class="btn" onclick="runFullAnalysis()">ì‹¤ì‹œê°„ ë°ì´í„° ë¶„ì„</button>
        </div>

        <div id="card-all" class="analysis-card" onclick="toggleHighlight('all')">
            <span class="res-title">ğŸŒ ë¯¸í™•ë³´ ì „ì²´ ê¸°ì¤€ ìµœì </span>
            <div id="all-content">ë¶„ì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>

        <div id="card-pri" class="analysis-card" onclick="toggleHighlight('pri')">
            <span class="res-title">â­ ìš°ì„ ìˆœìœ„ ëª©í‘œ ê¸°ì¤€ ìµœì </span>
            <div id="pri-content">ë¶„ì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>
    </div>

    <script>
        const WEAPON_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSvCoDDcCH_LVoRliGUwW0cAGOJtps8Ucmjj_ENOJxSuyGowRtq2heV5jh8VkVVTnwCoguGecjAkT6v/pub?gid=1336240927&single=true&output=csv";
        const PARTS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSvCoDDcCH_LVoRliGUwW0cAGOJtps8Ucmjj_ENOJxSuyGowRtq2heV5jh8VkVVTnwCoguGecjAkT6v/pub?gid=545530430&single=true&output=csv";

        let weaponData = [];
        let inventory = [];
        let analysisResults = { all: null, pri: null };

        async function init() {
            const [wRes, pRes] = await Promise.all([fetch(WEAPON_CSV), fetch(PARTS_CSV)]);
            weaponData = parseCSV(await wRes.text());
            inventory = parseCSV(await pRes.text());
            renderTable();
        }

        function renderTable(highlightMode = null) {
            const body = document.getElementById('weapon-body');
            const sorted = [...weaponData].sort((a, b) => {
                const aDone = a['ê¸°ì§ˆë³´ìœ '] === 'ã…‡' ? 1 : 0;
                const bDone = b['ê¸°ì§ˆë³´ìœ '] === 'ã…‡' ? 1 : 0;
                if (aDone !== bDone) return aDone - bDone;

                const aPri = a['ìš°ì„ ìˆœìœ„'] === 'ã…‡' ? 1 : 0;
                const bPri = b['ìš°ì„ ìˆœìœ„'] === 'ã…‡' ? 1 : 0;
                if (aPri !== bPri) return bPri - aPri;

                return a['ê¸°ì´ˆì†ì„±'].localeCompare(b['ê¸°ì´ˆì†ì„±']) || a['ì¶”ê°€ì†ì„±'].localeCompare(b['ì¶”ê°€ì†ì„±']);
            });

            body.innerHTML = sorted.map(w => {
                let hClass = '';
                if (highlightMode === 'all' && analysisResults.all?.targets.some(t => t['ë¬´ê¸°ëª…'] === w['ë¬´ê¸°ëª…'])) hClass = 'active-all';
                if (highlightMode === 'pri' && analysisResults.pri?.targets.some(t => t['ë¬´ê¸°ëª…'] === w['ë¬´ê¸°ëª…'])) hClass = 'active-pri';

                return `<tr class="${hClass}">
                    <td>${w['ë¬´ê¸°ëª…']}</td><td>${w['ì‚¬ìš©ìºë¦­']}</td>
                    <td class="col-fixed">${w['ë¬´ê¸°ë³´ìœ ']}</td><td class="col-fixed">${w['ìš°ì„ ìˆœìœ„']}</td>
                    <td class="col-attr">${w['ê¸°ì´ˆì†ì„±']}</td><td class="col-attr">${w['ì¶”ê°€ì†ì„±']}</td>
                    <td class="col-attr">${w['ìŠ¤í‚¬ì†ì„±']}</td><td class="col-fixed">${w['ê¸°ì§ˆë³´ìœ ']}</td>
                </tr>`;
            }).join('');
        }

        async function runFullAnalysis() {
            const aRes = await fetch('areas.json');
            const areas = await aRes.json();
            const needed = weaponData.filter(w => !inventory.some(p => p['ê¸°ì´ˆì†ì„±'] === w['ê¸°ì´ˆì†ì„±'] && p['ì¶”ê°€ì†ì„±'] === w['ì¶”ê°€ì†ì„±'] && p['ìŠ¤í‚¬ì†ì„±'] === w['ìŠ¤í‚¬ì†ì„±']));
            const priorities = needed.filter(w => w['ìš°ì„ ìˆœìœ„'] === 'ã…‡');

            analysisResults.all = findBest(areas, needed);
            analysisResults.pri = findBest(areas, priorities);

            updateCard('all', analysisResults.all);
            updateCard('pri', analysisResults.pri);
            toggleHighlight('all'); 
        }

        function findBest(areas, list) {
            let best = { score: 0, targets: [] };
            if (list.length === 0) return null;

            areas.forEach(area => {
                [...new Set([...area.extra, ...area.skill])].forEach(fixed => {
                    const matches = list.filter(w => area.base.includes(w['ê¸°ì´ˆì†ì„±']) && (w['ì¶”ê°€ì†ì„±'] === fixed || w['ìŠ¤í‚¬ì†ì„±'] === fixed));
                    if (matches.length > 0) {
                        const baseCounts = {};
                        matches.forEach(w => baseCounts[w['ê¸°ì´ˆì†ì„±']] = (baseCounts[w['ê¸°ì´ˆì†ì„±']] || 0) + 1);
                        const topBases = Object.entries(baseCounts).sort((a,b) => b[1]-a[1]).slice(0,3).map(e => e[0]);
                        const finalTargets = matches.filter(w => topBases.includes(w['ê¸°ì´ˆì†ì„±']));
                        if (finalTargets.length > best.score) {
                            best = { area: area.name, fixed, bases: topBases, score: finalTargets.length, targets: finalTargets };
                        }
                    }
                });
            });
            return best.score > 0 ? best : null;
        }

        function updateCard(type, data) {
            const container = document.getElementById(`${type}-content`);
            if (!data) { container.innerHTML = "í•´ë‹¹í•˜ëŠ” ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
            container.innerHTML = `<div class="res-value">${data.area} / ${data.fixed}</div>
                <div>${data.bases.map(b => `<span class="tag">${b}</span>`).join('')}</div>
                <small style="color:#aaa;">ğŸ¯ ${data.score}ì¢… ì €ê²© ê°€ëŠ¥</small>`;
        }

        function toggleHighlight(mode) {
            document.querySelectorAll('.analysis-card').forEach(c => c.classList.remove('active'));
            document.getElementById(`card-${mode}`).classList.add('active');
            renderTable(mode);
        }

        function parseCSV(csv) {
            const lines = csv.trim().split("\n");
            const headers = lines[0].split(",").map(h => h.trim().replace("\r", ""));
            return lines.slice(1).map(line => {
                const values = line.split(",").map(v => v.trim().replace("\r", ""));
                return headers.reduce((obj, h, i) => (obj[h] = values[i] || "", obj), {});
            });
        }

        init();
    </script>
</body>
</html>
